<h1 class="entry-title">Service Item Selection&nbsp;(Updated)</h1>
		<div class="entry-meta">
			Posted on <a href="http://cloudformsnow.com/2014/10/11/service-item-selection/" title="00:23" rel="bookmark"><time class="entry-date" datetime="2014-10-11T00:23:35+00:00">October 11, 2014</time></a><span class="byline"> by <span class="author vcard"><a class="url fn n" href="http://cloudformsnow.com/author/johnhardy36/" title="View all posts by johnhardy36" rel="author">johnhardy36</a></span></span>		</div><!-- .entry-meta -->
	</header><!-- .entry-header -->

	<div class="entry-content">
		<p>Here is something I get a lot,</p>
<p>“How can I make a service with multiple service items, but then conditional drop some during the deployment?”</p>
<p>Eg. You have a Service Dialog like this one here;</p>
<p>Download <a href="https://github.com/jonnyfiveiq/CloudFORMSNOW/blob/master/CFME/Services/Stopper/Sample_Dialog.yaml">https://github.com/jonnyfiveiq/CloudFORMSNOW/blob/master/CFME/Services/Stopper/Sample_Dialog.yaml</a></p>
<p><a href="https://cloudformsnow.files.wordpress.com/2014/10/screen-shot-2014-10-10-at-14-11-00.png"><img scale="2" src-orig="https://cloudformsnow.files.wordpress.com/2014/10/screen-shot-2014-10-10-at-14-11-00.png?w=300&amp;h=123" originalh="123" originalw="300" class="alignnone size-medium wp-image-354" src="https://cloudformsnow.files.wordpress.com/2014/10/screen-shot-2014-10-10-at-14-11-00.png?w=600&amp;h=248" alt="Screen Shot 2014-10-10 at 14.11.00" height="123" width="300"></a></p>
<p>Giving the user the option to select QA, Test or Production.</p>
<p>The decision would evaluate to one of 3 backing Service Items. Shown here in this diagram;</p>
<p><a href="https://cloudformsnow.files.wordpress.com/2014/10/slide1.png"><img scale="2" src-orig="https://cloudformsnow.files.wordpress.com/2014/10/slide1.png?w=300&amp;h=225" originalh="225" originalw="300" class="alignnone size-medium wp-image-355" src="https://cloudformsnow.files.wordpress.com/2014/10/slide1.png?w=600&amp;h=450" alt="Slide1" height="225" width="300"></a></p>
<p>Each service item here maybe RHEV, OpenStack or VMware. They might be all AWS/EC2 but different AMI’s etc!</p>
<p>So back to the use case,</p>
<p>How do I remove the service items&nbsp;I do not want to use from the service bundle (Nobody mention ZSTOP!)</p>
<p>Lets go through the solution;</p>
<p>1. You need to have a state machine for EACH service item. It can be the same state machine, but either way you need to specify one.</p>
<p>So, when you create each service item, and I am not concerned with the contents here (EC2, RHOS, RHEV, VMware etc..) You need to specify an entry point to a state machine that you have edit rights to as show here;</p>
<p><a href="https://cloudformsnow.files.wordpress.com/2014/10/screen-shot-2014-10-10-at-14-10-36.png"><img scale="2" src-orig="https://cloudformsnow.files.wordpress.com/2014/10/screen-shot-2014-10-10-at-14-10-36.png?w=300&amp;h=181" originalh="181" originalw="300" class="alignnone size-medium wp-image-351" src="https://cloudformsnow.files.wordpress.com/2014/10/screen-shot-2014-10-10-at-14-10-36.png?w=600&amp;h=364" alt="Screen Shot 2014-10-10 at 14.10.36" height="181" width="300"></a></p>
<p><a href="https://cloudformsnow.files.wordpress.com/2014/10/screen-shot-2014-10-10-at-14-10-49.png"><img scale="2" src-orig="https://cloudformsnow.files.wordpress.com/2014/10/screen-shot-2014-10-10-at-14-10-49.png?w=300&amp;h=193" originalh="193" originalw="300" class="alignnone size-medium wp-image-353" src="https://cloudformsnow.files.wordpress.com/2014/10/screen-shot-2014-10-10-at-14-10-49.png?w=600&amp;h=386" alt="Screen Shot 2014-10-10 at 14.10.49" height="193" width="300"></a></p>
<p><a href="https://cloudformsnow.files.wordpress.com/2014/10/screen-shot-2014-10-10-at-14-10-43.png"><img scale="2" src-orig="https://cloudformsnow.files.wordpress.com/2014/10/screen-shot-2014-10-10-at-14-10-43.png?w=300&amp;h=194" originalh="194" originalw="300" class="alignnone size-medium wp-image-352" src="https://cloudformsnow.files.wordpress.com/2014/10/screen-shot-2014-10-10-at-14-10-43.png?w=600&amp;h=390" alt="Screen Shot 2014-10-10 at 14.10.43" height="194" width="300"></a></p>
<p>The bundle that has these three service items can be whatever you like, here is mine, its just using its own state machine as you should do, but nothing special happening here.</p>
<p><a href="https://cloudformsnow.files.wordpress.com/2014/10/screen-shot-2014-10-10-at-14-10-24.png"><img scale="2" src-orig="https://cloudformsnow.files.wordpress.com/2014/10/screen-shot-2014-10-10-at-14-10-24.png?w=300&amp;h=208" originalh="208" originalw="300" class="alignnone size-medium wp-image-350" src="https://cloudformsnow.files.wordpress.com/2014/10/screen-shot-2014-10-10-at-14-10-24.png?w=600&amp;h=416" alt="Screen Shot 2014-10-10 at 14.10.24" height="208" width="300"></a></p>
<p>So looking at the Automate browser what do these state machines look like in file view?</p>
<p><a href="https://cloudformsnow.files.wordpress.com/2014/10/screen-shot-2014-10-10-at-20-13-35.png"><img scale="2" src-orig="https://cloudformsnow.files.wordpress.com/2014/10/screen-shot-2014-10-10-at-20-13-35.png?w=174&amp;h=300" originalh="300" originalw="174" class="alignnone size-medium wp-image-356" src="https://cloudformsnow.files.wordpress.com/2014/10/screen-shot-2014-10-10-at-20-13-35.png?w=348&amp;h=300" alt="Screen Shot 2014-10-10 at 20.13.35" height="300" width="174"></a></p>
<p>2. The state machine has many steps, Pre1, Pre2, Pre3, Provisioin, Post Provision etc.. We want to edit Pre1 and put something for the state machine to process. We are going to call out to a method that decides to either keep this service item or to dump it out. So exactly like a conditional processor but done using some simple ruby code rather than the nice GUI’s we see in Control, Reporting and Filtering (That may come later in ManageIQ hopefully)</p>
<p>The code simply takes the value from the Dialog for an attribute. In my case it is “Dialog_Environment”, the possible outcomes for this attribute are “Test, QA or Production”</p>
<p>The next thing we do is take the value of the state machine we are running, so I have added to the state machine schema an Attribute field called “State_Environment”. Now I know what the user selected and what the current service I am running is.</p>
<p>So you should edit the schema of the &lt;YourDOMAIN&gt;/Service/Provisioning/StateMachines/ServiceProvision_Template class to include this new attribute called “State_Environment” here is a picture to show you the finished edit;</p>
<p><a href="https://cloudformsnow.files.wordpress.com/2014/10/screen-shot-2014-10-10-at-20-20-31.png"><img scale="2" src-orig="https://cloudformsnow.files.wordpress.com/2014/10/screen-shot-2014-10-10-at-20-20-31.png?w=300&amp;h=45" originalh="45" originalw="300" class="alignnone size-medium wp-image-358" src="https://cloudformsnow.files.wordpress.com/2014/10/screen-shot-2014-10-10-at-20-20-31.png?w=600&amp;h=90" alt="Screen Shot 2014-10-10 at 20.20.31" height="45" width="300"></a></p>
<p>If the value of&nbsp;Dialog_Environment is NOT&nbsp;same as&nbsp;State_Environment then we want to dump this Service Item.</p>
<p>Here is the method; Its called Stopper, its a state on each of the Service Item State Machines, I shall show you this next;</p>
<div><div id="highlighter_82711" class="syntaxhighlighter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby keyword">def</code> <code class="ruby plain">mark_task_invalid(task)</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">task.finished(</code><code class="ruby string">"Invalid"</code><code class="ruby plain">)</code></div><div class="line number3 index2 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">task.miq_request_tasks.</code><code class="ruby keyword">each</code> <code class="ruby keyword">do</code> <code class="ruby plain">|t|</code></div><div class="line number4 index3 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby constants">2</code><code class="ruby plain">.times { </code><code class="ruby variable bold">$evm</code><code class="ruby plain">.log(</code><code class="ruby string">"info"</code><code class="ruby plain">, </code><code class="ruby string">"********************************DUMPING TASK #{t}*************************************"</code><code class="ruby plain">) }</code></div><div class="line number5 index4 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">mark_task_invalid(t)</code></div><div class="line number6 index5 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">end</code></div><div class="line number7 index6 alt2"><code class="ruby keyword">end</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="ruby constants">10</code><code class="ruby plain">.times { </code><code class="ruby variable bold">$evm</code><code class="ruby plain">.log(</code><code class="ruby string">"info"</code><code class="ruby plain">, </code><code class="ruby string">"*********************************************************************"</code><code class="ruby plain">) }</code></div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1"><code class="ruby plain">stp_task = </code><code class="ruby variable bold">$evm</code><code class="ruby plain">.root[</code><code class="ruby string">"service_template_provision_task"</code><code class="ruby plain">]</code></div><div class="line number13 index12 alt2"><code class="ruby plain">miq_request_id = </code><code class="ruby variable bold">$evm</code><code class="ruby plain">.vmdb(</code><code class="ruby string">'miq_request_task'</code><code class="ruby plain">, stp_task.get_option(</code><code class="ruby color2">:parent_task_id</code><code class="ruby plain">))</code></div><div class="line number14 index13 alt1"><code class="ruby plain">dialogOptions = miq_request_id.get_option(</code><code class="ruby color2">:dialog</code><code class="ruby plain">)</code></div><div class="line number15 index14 alt2">&nbsp;</div><div class="line number16 index15 alt1"><code class="ruby variable bold">$evm</code><code class="ruby plain">.log(</code><code class="ruby string">"info"</code><code class="ruby plain">, </code><code class="ruby string">"Dialog_Environment #{dialogOptions['dialog_environment'].downcase}"</code><code class="ruby plain">)</code></div><div class="line number17 index16 alt2"><code class="ruby variable bold">$evm</code><code class="ruby plain">.log(</code><code class="ruby string">"info"</code><code class="ruby plain">, </code><code class="ruby string">"State_Environment #{$evm.root['State_Environment'].downcase}"</code><code class="ruby plain">)</code></div><div class="line number18 index17 alt1">&nbsp;</div><div class="line number19 index18 alt2"><code class="ruby keyword">if</code> <code class="ruby plain">dialogOptions[</code><code class="ruby string">'dialog_environment'</code><code class="ruby plain">].downcase != </code><code class="ruby variable bold">$evm</code><code class="ruby plain">.root[</code><code class="ruby string">'State_Environment'</code><code class="ruby plain">].downcase</code></div><div class="line number20 index19 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby variable bold">$evm</code><code class="ruby plain">.log(</code><code class="ruby string">"info"</code><code class="ruby plain">, </code><code class="ruby string">"NO MATCH - DUMPING Service from resolution"</code><code class="ruby plain">)</code></div><div class="line number21 index20 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">task = </code><code class="ruby variable bold">$evm</code><code class="ruby plain">.root[</code><code class="ruby string">"service_template_provision_task"</code><code class="ruby plain">]</code></div><div class="line number22 index21 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">mark_task_invalid(task)</code></div><div class="line number23 index22 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">exit </code><code class="ruby constants">MIQ_STOP</code></div><div class="line number24 index23 alt1"><code class="ruby keyword">end</code></div><div class="line number25 index24 alt2">&nbsp;</div><div class="line number26 index25 alt1"><code class="ruby variable bold">$evm</code><code class="ruby plain">.log(</code><code class="ruby string">"info"</code><code class="ruby plain">, </code><code class="ruby string">"MATCH FOUND - Processing Service Normally"</code><code class="ruby plain">)</code></div><div class="line number27 index26 alt2">&nbsp;</div><div class="line number28 index27 alt1"><code class="ruby constants">10</code><code class="ruby plain">.times { </code><code class="ruby variable bold">$evm</code><code class="ruby plain">.log(</code><code class="ruby string">"info"</code><code class="ruby plain">, </code><code class="ruby string">"*********************************************************************"</code><code class="ruby plain">) }</code></div></div></td></tr></tbody></table></div></div>
<p>Download the Stopper method here&nbsp;<a href="https://github.com/jonnyfiveiq/CloudFORMSNOW/blob/master/CFME/Services/Stopper/Stopper.rb">Stopper.rb</a></p>
<p>So, the Stopper method needs to be placed somewhere, I instructed you do this on the Pre1 of EACH service item state machine. Here is an example of the QA state machine, this is the entry point for the service item QA. I have used the ON_ENTRY state, but you must leave the other states intact, you will see why in point number 3 coming next.</p>
<p><a href="https://cloudformsnow.files.wordpress.com/2014/10/screen-shot-2014-10-10-at-20-16-30.png"><img scale="2" src-orig="https://cloudformsnow.files.wordpress.com/2014/10/screen-shot-2014-10-10-at-20-16-30.png?w=300&amp;h=173" originalh="173" originalw="300" class="alignnone size-medium wp-image-357" src="https://cloudformsnow.files.wordpress.com/2014/10/screen-shot-2014-10-10-at-20-16-30.png?w=600&amp;h=348" alt="Screen Shot 2014-10-10 at 20.16.30" height="173" width="300"></a></p>
<p>3. Now we do have a small issue to deal with, notice in the previous step the code exit is MIQ_STOP. This is great on one hand because it stops this state machine processing any further, but breaks in another as the ae_result is populated with “error” and when the bundle starts to look at its children for status it sees “error” and barfs out the entire Service Bundle, not good. So we have to fake the ae_result back to OK once we know that the reason for being “Error” is because we want it to be and not because its a genuine error. Make sense?</p>
<p>So we have an OOTB method called “update_serviceprovision_status”, its the job of this method to watch the service deployments and bump the return status around depending on its value. In here we simply do a check to say;</p>
<p>Is the item we are looking at for status, have a status value of “Invalid”, because this is unique and not a Cloudforms status, its been set specially&nbsp;by us for this use case. If it is “Invalid” then we know that this service needs its “ae_result” forced to be “ok” and to exit MIQ_OK. Making everyone happy, the service bundle thinks its provisioned the service when it actually did not, moving onto the next service item in the bundle.</p>
<p>Here is the NEW check_provision method that you need to create in your domain, I would simply copy the one from;</p>
<p>/ManageIQ/Service/Provisioning/StateMachines/ServiceProvision_Template/update_serviceprovision_status</p>
<p>And either copy this code in, just place it near the top, before the processing of the objects;</p>
<div><div id="highlighter_548156" class="syntaxhighlighter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby comments"># Bypass errors for Invalid instances</code></div><div class="line number2 index1 alt1"><code class="ruby keyword">if</code> <code class="ruby plain">prov.message == </code><code class="ruby string">'Invalid'</code></div><div class="line number3 index2 alt2"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby variable bold">$evm</code><code class="ruby plain">.log(</code><code class="ruby string">"info"</code><code class="ruby plain">,</code><code class="ruby string">"Skipping Invalid Services"</code><code class="ruby plain">)</code></div><div class="line number4 index3 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby variable bold">$evm</code><code class="ruby plain">.root[</code><code class="ruby string">'ae_result'</code><code class="ruby plain">] = </code><code class="ruby string">'ok'</code></div><div class="line number5 index4 alt2"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">message = </code><code class="ruby string">'Service Provisioned Successfully'</code></div><div class="line number6 index5 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">prov.finished(prov.message)</code></div><div class="line number7 index6 alt2"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">exit </code><code class="ruby constants">MIQ_OK</code></div><div class="line number8 index7 alt1"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
<p>or download this new one from here&nbsp;<a href="https://github.com/jonnyfiveiq/CloudFORMSNOW/blob/master/CFME/Services/Stopper/update_serviceprovision_status.rb">update_serviceprovision_status.rb</a></p>
<p>I hope this all works for you, its a great use case and one we talk&nbsp;about all the time.</p>
<p>Obviously there are more than one way to do this, but most other routes either fail the bundle (bad) or require generic service items and loads more code. This is re-usable, could be prodctised and easily repeatable without a lot of effort. With the new domains in 3.1 you can have this in your tool box.</p>
<p>I will raise a discussion on talk.manageiq.org to share this, and get input on having the GUI conditional processor available in the Service Item designer phase.</p>

